# CNN for sonar descriptor computation

## Prerequisites

 - python 3.8 or higher
 - CUDA 11.6 or higher
 - Eigen3

## Installation

```bash
$ pip install -r requirements.txt
$ python3 setup.py build_ext
```

## Notation

All python files ending with "_bruce" are used on path datasets, the others refer to grid datasets.

"Grid datasets" are the ones created by our synthetic sonar image simulation tool, while "path datasets" are the ones taken during real experiments (Wang2022, Aracati2014, Aracati2017).

## Data 

To train/evaluate the network you need the datasets folders to be organized in the following way:

- Training dataset: a folder (which will be referred to as `train_dir` for the rest of the document) containing two subfolders:
    - `imgs`: containing the RGB training images. Each image is assumed to represent the 360° sonar scan in the range (-90°;270°) of the field of view. We concateneated three 120° multibeam sonars to simulate 360°.
    - `poses`: containing the poses related to the images in a txt file for each image. Each pose file contains the XYZ coordinates in the first line and the orientation in the second line, expressed as the xyzw components of a quaternion. Component on both lines are separated by a whitespace.
  Each file in the two directories should be named with integers in increasing order. For example the first image is in `imgs/0.jpeg` and the related pose in `poses/0.txt` .
- Test/validation dataset: follows the same structure as the training dataset and will be referred as `test_dir` for the rest of the document.

Both `train_dir` and `test_dir` should only contain images in which at least one asset is visible, that is only images where it is possible to localize the drone. A separate folder will contain the trained models and will be named `model_dir` for the rest of the document.

## Configuration files

Configuration files are stored in `configs/` and are used to modify the network parameters. A sample configuration file can be found in such directory with a description of all possible parameters which can be specified: `configs/sample.yaml`.

## Network training

The script `main.py` allows the user to train the network on the desired grid dataset.

```
$ python3 main.py -h

  usage: main.py [-h] -t TRAIN_DIR -v VAL_DIR -g GT_SIM -m MODEL_DIR --cfg_file CFG_FILE --epochs EPOCHS ...

 DescNet training tool
 
   -h, --help            show this help message and exit
   -t TRAIN_DIR, --train_dir TRAIN_DIR
                         Input directory containing the training dataset
   -v VAL_DIR, --val_dir VAL_DIR
                         Input directory containing the validation dataset
   -g GT_SIM, --gt_sim GT_SIM
                         Input ground truth similarity file. If it does not exist it will be computed and saved at the given path. (.npy extension)
   -m MODEL_DIR, --model_dir MODEL_DIR
                         Output directory where the trained models will be stored
   --cfg_file CFG_FILE   Configuration file
   --epochs EPOCHS       Number of training epochs
```

## Generating descriptor database

Once the network is trained, it is possible to use it to generate a database of descriptors from training images. The database is stored as a .txt file where:

- the first line contains two integers: the stride of the sliding window over the image features and the width in pixels of the feature map generated by the backbone for each image, in that order;
- all other lines contain: an array of floats representing an image  descriptor, an array of float represesenting the XYZ position associated to the descriptor and an integer containing the yaw angle of the image, in that order;

Generating the txt database can be done with the `generate_database.py` script for grid datasets , and with the `generate_database_bruce.py` script for  path databases:

```
$ python3 generate_database.py -h

 usage: generate_database.py [-h] -d DATASET_DIR -m MODEL_DIR -o OUTPUT_FN --cfg_file CFG_FILE ...
 
 Database generation tool for grid datasets.
 
   -h, --help            show this help message and exit
   -d DATASET_DIR, --dataset_dir DATASET_DIR
                         Input directory containing the training dataset
   -m MODEL_DIR, --model_dir MODEL_DIR
                         Input directory where the trained model is stored. If an invalid directory is provided, an untrained model will be generated and used.
   -o OUTPUT_FN, --output_fn OUTPUT_FN
                         Output file in which to store the generated database. (.txt extension)
   --cfg_file CFG_FILE   Configuration file

```

```
$ python3 generate_database_bruce.py -h

 usage: generate_database_bruce.py [-h] -d DATASET_DIR -m MODEL_DIR -o OUTPUT_FN --cfg_file CFG_FILE ...
 
 Database generation tool for path datasets.
 
   -h, --help            show this help message and exit
   -d DATASET_DIR, --dataset_dir DATASET_DIR
                         Input directory containing the training dataset.
   -m MODEL_DIR, --model_dir MODEL_DIR
                         Input directory where the trained model is stored. If an invalid directory is provided, an untrained model will be generated and used.
   -o OUTPUT_FN, --output_fn OUTPUT_FN
                         Output file in which to store the generated datbase. (.txt extension)
   --cfg_file CFG_FILE   Configuration file

```

## Network testing

The script `eval.py` allows the user to evaluate the performance of a trained model on the desired grid test set. `eval_bruce.py`, instead, allows evaluation on a path datasets.

```
$ python3 eval.py -h

 usage: eval.py [-h] [--from_database] -d DATABASE -g GT_SIM -t TEST_DATASET_DIR -m MODEL_DIR --cfg_file CFG_FILE ...
 
 DescNet eval tool for grid datasets.
 
   -h, --help            show this help message and exit
   --from_database       If this option is specified the database of descriptor is loaded from file, otherwise it is computed online
   -d DATABASE, --database DATABASE
                         if from_database is true this is the input descriptor database file, otherwise it is the folder containing the dataset.
   -g GT_SIM, --gt_sim GT_SIM
                         Input ground truth similarity file. If it does not exist it will be computed and saved at the given path. (.npy extension)
   -t TEST_DATASET_DIR, --test_dataset_dir TEST_DATASET_DIR
                         Input directory containing the test dataset.
   -m MODEL_DIR, --model_dir MODEL_DIR
                         Input directory where the trained model is stored.
   --cfg_file CFG_FILE   Configuration file

```


```
$ python3 eval.py -h

 usage: eval_bruce.py [-h] [--from_database] -d DATABASE -t TEST_DATASET_DIR -g GT_SIM -m MODEL_DIR --cfg_file CFG_FILE ...

 DescNet eval tool for path datasets
 
   -h, --help            show this help message and exit
   --from_database       If this option is specified the database of descriptor is loaded from file, otherwise it is computed online.
   -d DATABASE, --database DATABASE
                         if from_database is true this is the input descriptor database file, otherwise it is the folder containing the path dataset.
   -t TEST_DATASET_DIR, --test_dataset_dir TEST_DATASET_DIR
                         Input directory containing the test set (same as the one used to compute the descriptors database)
   -g GT_SIM, --gt_sim GT_SIM
                         Input ground truth similarity file. If it does not exist it will be computed and saved at the given path. (.npy exteension)
   -m MODEL_DIR, --model_dir MODEL_DIR
                         Input directory where the trained model is stored
   --cfg_file CFG_FILE   Configuration file

```

## Database visualization

An additional tool is provided to show the pose distribution covered by a database of descriptors. Each pose will be represented with an arrow starting from the poition associated wit each descriptors and directed according to its related yaw.

```
$ python3 show_database.py -h

 usage: show_database.py [-h] -d DATABASE --cfg_file CFG_FILE ...
 
 Descriptor database pose visualization tool.
 
 positional arguments:
   opts
 
 optional arguments:
   -h, --help            show this help message and exit
   -d DATABASE, --database DATABASE
                         input descriptor database file
   --cfg_file CFG_FILE   Configuration file
```




